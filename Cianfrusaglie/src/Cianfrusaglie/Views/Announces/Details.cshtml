@using System.Collections
@using System.Collections.Generic
@using System.Security.Claims
@using System.Threading.Tasks
@using Microsoft.Data.Entity.Query.Expressions
@using Remotion.Linq.Clauses
@model Cianfrusaglie.Models.Announce

@{
    ViewData["Title"] = "Details";
}

<script src="http://maps.googleapis.com/maps/api/js?libraries=places"></script>
<script src="/js/googleMaps.js" ></script>
<script>
    function parseFloatIgnoreCommas(number) {
        var numberNoCommas = number.replace(/,/g, '.');
        return parseFloat(numberNoCommas);
    }

    $(document).ready( function() {
        var latitude = parseFloatIgnoreCommas("@Model.Latitude");
        var longitude = parseFloatIgnoreCommas("@Model.Longitude");
        var position = new google.maps.LatLng(latitude, longitude);
        initializeGMaps(position, true, @Model.MeterRange);
    } );
</script>

<div id="wrapper-announce">


    <div class="row">
        <div class="col-sm-10 col-md-5">
            <!--IMMAGINI + carosello-->
            <div class="col-item" style="">
                <div class="photo carousel slide" id="carosello">
                    
                    <!--Pallini nelle immagini -->
                    <ol class="carousel-indicators" style="z-index: 1">
                        @{
                            var count = 0;
                            foreach (var i in (IEnumerable<ImageUrl>) ViewData["Images"])
                            {
                                if (count == 0)
                                {
                                    <li data-target="#carosello" class="active"></li>
                                }
                                else
                                {
                                    <li data-target="#carosello"></li>
                                }
                                count = count + 1;
                            }
                        }
                    </ol>
                    <!--ELEMENTI DEL CAROSELLO-->
                    <div class="carousel-inner">
                        @{
                            var count2 = 0;
                            foreach (var immagine in (IEnumerable<ImageUrl>) ViewData["Images"])
                            {
                                if (count2 == 0)
                                {
                                    <div class="item active">
                                        <img src="@immagine.Url" class="img-responsive" alt="a"/>
                                    </div>
                                }
                                else
                                {
                                    <div class="item">
                                        <img src="@immagine.Url" class="img-responsive" alt="a"/>
                                    </div>
                                }
                                count2 = count2 + 1;
                            }
                        }
                    </div>
                    <!-- FRECCE PER IL CONTROLLO-->
                    <a class="left carousel-control" href="#carosello" role="button" data-slide="prev">
                        <span class="glyphicon glyphicon-chevron-left"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="right carousel-control" href="#carosello" role="button" data-slide="next">
                        <span class="glyphicon glyphicon-chevron-right"></span>
                        <span class="sr-only">Next</span>
                    </a>
                    
                </div>
               
            </div>
        </div>
        <div class="col-sm-10 col-md-5">
            <h2 id="titolo">@Html.DisplayName(Model.Title)</h2>

            @if (@ViewData["interested"] == null && !Model.Closed && !Model.AuthorId.Equals(User.GetUserId()))
            {
                <div class="icon-detail">
                    <form action="#" method="POST">
                        <a name="confirm_levels" value="Interessato"><span class="glyphicon glyphicon-plus-sign icon-det"></span><span class="text-det">Interessato</span></a>
                    </form>
                </div>
            }
            else if (!Model.Closed && !Model.AuthorId.Equals(User.GetUserId()))
            {
                <div class="icon-detail">
                    <form action="#" method="POST">
                        <a name="confirm_levels" value="Interessato"><span class="glyphicon glyphicon-plus-sign icon-det"></span><span class="text-det">Non sono pi&ugrave; interessato</span></a>
                    </form>
                </div>
            }




            <div class="col-item">
                <dl class="dl-horizontal container-announce">

                    @foreach (var f in (Dictionary<FormField, string>)ViewData["formFieldsValue"])
                    {

                        <dt>
                            @f.Key.Name
                        </dt>
                            <dd>
                                @f.Value
                            </dd>
                    }

                    @if (Model.Description != null)
                    {
                        <dt>
                            Dettagli annuncio
                        </dt>
                            <dd>
                                @Html.DisplayFor(model => model.Description)
                            </dd>
                    }
                    @if (Model.Price > 0)
                    {
                        <dt>
                            Prezzo
                        </dt>
                            <dd>
                                @Html.DisplayFor(model => model.Price) &euro;
                            </dd>
                    }
                </dl>
            </div>

            <div class="col-item container-announce">
                <dl class="dl-horizontal">

                    <dt>
                        Autore
                    </dt>

                    @if ((string)ViewData["AuthorId"] != User.GetUserId())
                    {
                        <dd>
                            <div>
                                @ViewData["Autore"]
                                <a href="~/Messages/Details/?id=@ViewData["AuthorId"]" style="margin-left: 5em">Contatta</a>
                            </div>
                        </dd>
                    }
                    else
                    {
                        <dd>Hai creato tu questo annuncio</dd>
                    }
                    @if (Model.MeterRange > 0)
                    {

                        <dt style="white-space: normal">
                            @Html.DisplayName("Disponibile a muoversi")
                        </dt>
                            <dd>
                                Si
                            </dd>
                            <dt>
                                @Html.DisplayName("Range di disponibilita' in km")
                            </dt>
                            <dd>
                                @Html.DisplayFor(model => model.MeterRange)
                            </dd>
                    }
                    else
                    {
                        <dt>
                            Disponibile a muoversi
                        </dt>
                            <dd>
                                No
                            </dd>
                    }
                    <dt>
                        Data di Pubblicazione
                    </dt>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <dd>
                            @Html.DisplayFor(model => model.PublishDate)
                        </dd>
                    }
                    @if (Model.DeadLine != null)
                    {
                        <dt>
                            Questo annuncio scade il
                        </dt>
                            <dd>
                                @Html.DisplayFor(model => model.DeadLine)
                            </dd>
                    }
                </dl>
            </div>

            <div id="googleMap" style="width: 500px; height: 380px;"></div>

        </div>



    </div>

    <script type="text/javascript">
        

        $('a[name="confirm_levels"]').on('click', function (e) {
            var $form = $(this).closest('form');
            e.preventDefault();
            var tmp = @ViewData["IdAnnounce"];

            $('#confirm').modal({ backdrop: 'static', keyboard: false })
                .one('click', '#confirm', function (err) {
                    $.get( "/Announces/Interested?AnnounceId=" + tmp,
                            function() {
                                if( $('.text-det').text() === "Interessato" )
                                    $('.text-det').html("Non sono pi&ugrave; interessato");
                                else
                                    $('.text-det').text("Interessato");
                            })
                        .fail(function() { alert("error"); });
                });
        });
        
    </script>
    @*    <p>*@
    @*        <a asp-action="Edit" asp-route-id="@Model.Id">Edit</a> |*@
    @*        <a asp-action="Index">Back to List</a>*@
    @*    </p>*@
</div>




 
